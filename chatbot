import streamlit as st
import google.generativeai as genai
import requests
from bs4 import BeautifulSoup

# Google Gemini API ì„¤ì •
YOUR_API_KEY = "yourapi"  # ì‹¤ì œ API í‚¤ë¡œ êµì²´
genai.configure(api_key=YOUR_API_KEY)

# ì‹œìŠ¤í…œ ë©”ì‹œì§€ (íŒ¨ë¥´ì†Œë‚˜ ì ìš©)
system_instruction = """
ë‹¹ì‹ ì€ í”¼ë¶€ ìƒíƒœ ì§„ë‹¨ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ì‚¬ìš©ìì˜ í”¼ë¶€ ê³ ë¯¼ê³¼ í˜„ì¬ ì‚¬ìš©í•˜ëŠ” í™”ì¥í’ˆ ë“±ì„ ë°”íƒ•ìœ¼ë¡œ
ë§ì¶¤í˜• ìŠ¤í‚¨ì¼€ì–´ íŒê³¼ ì œí’ˆì„ ì¶”ì²œí•´ì£¼ì„¸ìš”.
ì‚¬ìš©ìì—ê²Œ ë‹µë³€ì„ í•  ë•Œ, ì§ˆë¬¸ì„ í•˜ë‚˜ì”© í•´ì„œ ì‚¬ìš©ìì™€ ëŒ€í™”í•˜ì„¸ìš”.
ì–´ëŠì •ë„ ì‚¬ìš©ìì˜ í”¼ë¶€íƒ€ì…ì„ ì•Œê³ , í”¼ë¶€íƒ€ì…ì— ë§ëŠ” ì œí’ˆì„ ì¶”ì²œí•  ìˆ˜ ìˆì„ ë•Œì—ëŠ”
'í”¼ë¶€íƒ€ì… ë¶„ì„ì„ ì™„ë£Œí•˜ì˜€ì–´ìš”. ì´ì œ ë§ì¶¤í˜• ì„±ë¶„ê³¼ ê´€ë¦¬ íŒì„ ì•Œë ¤ë“œë¦´ê²Œìš”'ë¼ëŠ” ë©”ì‹œì§€ë¥¼ ë„ìš´ í›„, ì œí’ˆ ì¶”ì²œì„ í•´ì£¼ì„¸ìš”.
'ì¶”ì²œ ì œí’ˆ'ëŒ€ì‹  'ìŠ¤í‚¨ì¼€ì–´ ë£¨í‹´ ë³„ ì¶”ì²œ ì„±ë¶„'ì´ë¼ê³  ë§í•˜ê³ , ì˜†ì—ëŠ” ğŸ«§ ì´ ì•„ì´ì½˜ì„, 
'ì¶”ê°€ íŒ'ì´ë¼ëŠ” ë§ 'ëŒ€ì‹  ë§ì¶¤í˜• í”¼ë¶€ ê´€ë¦¬ íŒ'ì´ë¼ê³  ë§í•˜ê³ , ì˜†ì—ëŠ” ğŸ’¡ ì´ ì•„ì´ì½˜ì„ ì¨ì¤˜. 
"""
model = genai.GenerativeModel("gemini-1.5-flash", system_instruction=system_instruction)

# Streamlit ì•± ì´ˆê¸°í™”
st.title("SKINCARE BOT")
st.write("í”¼ë¶€ ê³ ë¯¼ì— ëŒ€í•´ ì´ì•¼ê¸°í•˜ê³ , ë§ì¶¤í˜• í”¼ë¶€ê´€ë¦¬ íŒê³¼ ì„±ë¶„ì„ ì¶”ì²œë°›ì•„ë³´ì„¸ìš”!")

# ---- ë§¤ê°œë³€ìˆ˜ ì„¤ì • ë° ì„¤ëª… ----
st.sidebar.title("Generative AI ë§¤ê°œë³€ìˆ˜ ì„¤ì •")

# temperature: ì¶œë ¥ì˜ ë¬´ì‘ìœ„ì„± ì¡°ì •. ë‚®ì€ ê°’(ì˜ˆ: 0.2)ì€ ë³´ìˆ˜ì ì¸ ì‘ë‹µ, ë†’ì€ ê°’(ì˜ˆ: 1.5)ì€ ì°½ì˜ì  ì‘ë‹µì„ ìœ ë„.
temperature = st.sidebar.slider(
    "ì¶œë ¥ì˜ ë¬´ì‘ìœ„ì„±ì„ ì œì–´ (temperature)", 0.0, 2.0, 1.0, step=0.1
)

# ëŒ€í™” ì„¸ì…˜ ë° ê¸°ë¡ ê´€ë¦¬
if "chat_session" not in st.session_state:
    st.session_state["chat_session"] = model.start_chat(history=[])

if "messages" not in st.session_state:
    st.session_state["messages"] = []  # ì‚¬ìš©ìì™€ ì±—ë´‡ì˜ ë©”ì‹œì§€ ê¸°ë¡

# ë„¤ì´ë²„ ì‡¼í•‘ í¬ë¡¤ë§ í•¨ìˆ˜
def crawl_naver_shopping(keyword):
    base_url = "https://search.shopping.naver.com/search/all"
    params = {"query": keyword, "cat_id": "", "frm": "NVSHATC"}
    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"
    }

    response = requests.get(base_url, params=params, headers=headers)

    if response.status_code != 200:
        raise Exception(f"HTTP ìš”ì²­ ì‹¤íŒ¨: ìƒíƒœ ì½”ë“œ {response.status_code}")

    soup = BeautifulSoup(response.text, "html.parser")

    # í¬ë¡¤ë§ ê²°ê³¼ ì¶”ì¶œ
    products = []
    items = soup.select(".basicList_item__2XT81")  # ë„¤ì´ë²„ ì‡¼í•‘ ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ CSS ì„ íƒì
    for item in items[:5]:  # ìƒìœ„ 5ê°œ ìƒí’ˆë§Œ ê°€ì ¸ì˜¤ê¸°
        try:
            name = item.select_one(".basicList_title__3P9Q7").text.strip()
            price = item.select_one(".price_num__2WUXn").text.strip()
            link = item.select_one(".basicList_link__1MaTN")["href"]
            products.append({"name": name, "price": price, "link": link})
        except AttributeError:
            continue  # í•„ìš”í•œ ì •ë³´ê°€ ì—†ìœ¼ë©´ í•´ë‹¹ ì•„ì´í…œ ê±´ë„ˆë›°ê¸°

    return products

# ì´ì „ ëŒ€í™” ê¸°ë¡ í‘œì‹œ
for message in st.session_state["messages"]:
    with st.chat_message(message["role"]):
        st.markdown(message["content"])

# ì‚¬ìš©ì ì…ë ¥ í•„ë“œ
if prompt := st.chat_input("í”¼ë¶€ ê³ ë¯¼ì„ ì…ë ¥í•˜ì„¸ìš”:"):
    # ì‚¬ìš©ì ë©”ì‹œì§€ ê¸°ë¡ ë° í‘œì‹œ
    st.session_state["messages"].append({"role": "user", "content": prompt})
    with st.chat_message("user"):
        st.markdown(prompt)

    # ì±—ë´‡ ì‘ë‹µ ìƒì„± ë° í‘œì‹œ
    with st.chat_message("assistant"):
        message_placeholder = st.empty()
        message_placeholder.markdown("...")  # ì‘ë‹µ ëŒ€ê¸° ìƒíƒœ í‘œì‹œ

        try:
            # Google Gemini APIë¡œ ì‘ë‹µ ìƒì„±
            response = st.session_state["chat_session"].send_message(prompt)
            assistant_message = response.text  # ì‘ë‹µ í…ìŠ¤íŠ¸ ì¶”ì¶œ

            # ì±—ë´‡ ë©”ì‹œì§€ ê¸°ë¡ ë° í‘œì‹œ
            st.session_state["messages"].append({"role": "assistant", "content": assistant_message})
            message_placeholder.markdown(assistant_message)

            # ë„¤ì´ë²„ ì‡¼í•‘ í¬ë¡¤ë§ ì‹¤í–‰
            if "ì¶”ì²œ" in assistant_message:  # ì¶”ì²œ ì œí’ˆì´ ì–¸ê¸‰ë˜ë©´ í¬ë¡¤ë§ ì‹¤í–‰
                st.write("ğŸ›ï¸ ë„¤ì´ë²„ ì‡¼í•‘ì—ì„œ ì¶”ì²œ ì œí’ˆì„ ì°¾ê³  ìˆìŠµë‹ˆë‹¤...")
                try:
                    products = crawl_naver_shopping(prompt)
                    if products:
                        st.write("**ì¶”ì²œ ì œí’ˆ:**")
                        for product in products:
                            st.markdown(f"- [{product['name']}]({product['link']}) - {product['price']}")
                    else:
                        st.write("âŒ ê´€ë ¨ ì œí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                except Exception as e:
                    st.error(f"ë„¤ì´ë²„ ì‡¼í•‘ í¬ë¡¤ë§ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        except Exception as e:
            error_message = f"âŒ ì˜¤ë¥˜ ë°œìƒ: {e}"
            st.session_state["messages"].append({"role": "assistant", "content": error_message})
            message_placeholder.markdown(error_message)
